<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/891/891419.png" type="image/png">
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõí</text></svg>">
    <title>My Orders - USM E-Mart</title>
</head>
<body>
    <nav class="navTop">
        <div class="nav-left">
            <div class="logo-container">
                <div class="logo-circle">
                    <i class="fas fa-shopping-bag logo-icon"></i>
                </div>
                <p class="name">
                    USM E-Mart - My Orders
                </p>
            </div>
        </div>
        <div class="navItem">
            <a href="index.html" style="color: white; text-decoration: none;">‚Üê Back to Home</a>
        </div>
    </nav>
    
    <div class="orders-container">
        <div class="orders-header">
            <h2>My Orders</h2>
            <div class="order-filters">
                <button class="filter-btn active" onclick="filterOrders('all')">All Orders</button>
                <button class="filter-btn" onclick="filterOrders('processing')">Processing</button>
                <button class="filter-btn" onclick="filterOrders('completed')">Completed</button>
                <button class="filter-btn" onclick="filterOrders('cancelled')">Cancelled</button>
            </div>
        </div>
        
        <div id="ordersList">
            <!-- Orders will be loaded here -->
            <div class="loading-orders">
                <div class="loading-spinner"></div>
                <p>Loading your orders...</p>
            </div>
        </div>
        
        <div id="emptyOrders" style="display: none;">
            <div class="empty-orders">
                <div style="font-size: 80px; margin-bottom: 20px; opacity: 0.5;">üì¶</div>
                <h3>No Orders Yet</h3>
                <p>You haven't placed any orders yet.</p>
                <a href="index.html" class="btn-continue">Start Shopping</a>
            </div>
        </div>
    </div>
    
    <!-- Order Details Modal -->
    <div id="orderModal" class="modal" style="display: none;">
        <div class="modal-content order-modal-content">
            <div class="modal-header">
                <h3>Order Details</h3>
                <button onclick="closeOrderModal()" class="modal-close">√ó</button>
            </div>
            <div class="modal-body">
                <div id="orderDetails">
                    <!-- Order details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <script src="api-service.js"></script>
    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            await loadOrders();
        });
        
        async function loadOrders() {
            try {
                const orders = await ApiService.getOrders();
                displayOrders(orders);
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('ordersList').innerHTML = `
                    <div class="error-message">
                        <p>Failed to load orders. Please try again later.</p>
                        <button onclick="loadOrders()">Retry</button>
                    </div>
                `;
            }
        }
        
        function displayOrders(orders) {
            const ordersList = document.getElementById('ordersList');
            const emptyOrders = document.getElementById('emptyOrders');
            
            if (!orders || orders.length === 0) {
                ordersList.style.display = 'none';
                emptyOrders.style.display = 'block';
                return;
            }
            
            emptyOrders.style.display = 'none';
            ordersList.style.display = 'block';
            
            // Sort orders by date (newest first)
            orders.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = '';
            orders.forEach(order => {
                html += createOrderCard(order);
            });
            
            ordersList.innerHTML = html;
        }
        
        function createOrderCard(order) {
            const statusClass = getStatusClass(order.status);
            const total = order.total || 0;
            const itemCount = order.items ? order.items.reduce((sum, item) => sum + item.quantity, 0) : 0;
            
            // REMOVED: Cancel button from order card
            return `
                <div class="order-card ${statusClass}" onclick="viewOrderDetails('${order.id}')">
                    <div class="order-card-header">
                        <div class="order-info">
                            <h4>Order #${order.id.substring(0, 8)}</h4>
                            <span class="order-date">${formatDate(order.date)}</span>
                        </div>
                        <div class="order-status">
                            <span class="status-badge ${statusClass}">${order.status}</span>
                        </div>
                    </div>
                    
                    <div class="order-card-body">
                        <div class="order-summary">
                            <div class="order-item-count">
                                <span class="label">Items:</span>
                                <span class="value">${itemCount} item${itemCount !== 1 ? 's' : ''}</span>
                            </div>
                            <div class="order-total">
                                <span class="label">Total:</span>
                                <span class="value">RM ${total.toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div class="order-items-preview">
                            ${order.items && order.items.slice(0, 3).map(item => `
                                <div class="preview-item">
                                    <img src="${item.image}" alt="${item.name}" class="preview-image">
                                    <span class="preview-name">${item.name} √ó ${item.quantity}</span>
                                </div>
                            `).join('')}
                            ${order.items && order.items.length > 3 ? 
                                `<div class="more-items">+${order.items.length - 3} more</div>` : ''}
                        </div>
                    </div>
                    
                    <div class="order-card-footer">
                        <button class="btn-view-details" onclick="event.stopPropagation(); viewOrderDetails('${order.id}')">
                            View Details
                        </button>
                        <!-- REMOVED: Cancel Order button from card footer -->
                    </div>
                </div>
            `;
        }
        
        function getStatusClass(status) {
            switch(status?.toLowerCase()) {
                case 'processing': return 'status-processing';
                case 'completed': return 'status-completed';
                case 'cancelled': return 'status-cancelled';
                default: return 'status-processing';
            }
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        async function viewOrderDetails(orderId) {
            try {
                const orders = await ApiService.getOrders();
                const order = orders.find(o => o.id === orderId);
                
                if (!order) {
                    alert('Order not found');
                    return;
                }
                
                showOrderModal(order);
            } catch (error) {
                console.error('Error viewing order:', error);
                alert('Failed to load order details');
            }
        }
        
        function showOrderModal(order) {
            const modal = document.getElementById('orderModal');
            const orderDetails = document.getElementById('orderDetails');
            
            orderDetails.innerHTML = createOrderDetailsHTML(order);
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function closeOrderModal() {
            const modal = document.getElementById('orderModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        function createOrderDetailsHTML(order) {
            const total = order.total || 0;
            const subtotal = order.subtotal || 0;
            const fee = order.fee || 0;
            const statusClass = getStatusClass(order.status);
            
            // REMOVED: Contact seller and leave review buttons
            return `
                <div class="order-details-container">
                    <!-- Order Header -->
                    <div class="order-details-header">
                        <div>
                            <h4>Order #${order.id}</h4>
                            <p class="order-date">Placed on ${formatDate(order.date)}</p>
                        </div>
                        <div class="order-status-large">
                            <span class="status-badge ${statusClass}">${order.status}</span>
                        </div>
                    </div>
                    
                    <!-- Order Progress -->
                    <div class="order-progress">
                        <div class="progress-steps">
                            ${createProgressSteps(order.status)}
                        </div>
                    </div>
                    
                    <!-- Order Items -->
                    <div class="order-items-section">
                        <h4>Order Items (${order.items ? order.items.length : 0})</h4>
                        <div class="order-items-list">
                            ${order.items ? order.items.map(item => `
                                <div class="order-item-detail">
                                    <img src="${item.image}" alt="${item.name}" class="item-image">
                                    <div class="item-details">
                                        <div class="item-name">${item.name}</div>
                                        <div class="item-seller">Seller: ${item.seller}</div>
                                        <div class="item-quantity">Quantity: ${item.quantity}</div>
                                        <div class="item-price">RM ${item.price.toFixed(2)} each</div>
                                    </div>
                                    <div class="item-total">
                                        RM ${(item.price * item.quantity).toFixed(2)}
                                    </div>
                                </div>
                            `).join('') : '<p>No items found</p>'}
                        </div>
                    </div>
                    
                    <!-- Order Summary -->
                    <div class="order-summary-details">
                        <h4>Order Summary</h4>
                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span>RM ${subtotal.toFixed(2)}</span>
                        </div>
                        <div class="summary-row">
                            <span>Platform Fee (2%)</span>
                            <span>RM ${fee.toFixed(2)}</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total</span>
                            <span>RM ${total.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="order-actions">
                        <!-- REMOVED: Cancel Order button from order details -->
                        <!-- REMOVED: Contact Seller button -->
                        <!-- REMOVED: Leave Review button for completed orders -->
                        <button class="btn-print" onclick="printOrder('${order.id}')">
                            Print Receipt
                        </button>
                    </div>
                </div>
            `;
        }
        
        function createProgressSteps(status) {
            const steps = [
                { id: 'ordered', label: 'Ordered', icon: 'üì¶' },
                { id: 'confirmed', label: 'Confirmed', icon: '‚úì' },
                { id: 'processing', label: 'Processing', icon: 'üîÑ' },
                { id: 'ready', label: 'Ready for Pickup', icon: 'üìç' },
                { id: 'completed', label: 'Completed', icon: 'üéâ' }
            ];
            
            const statusIndex = {
                'processing': 2,
                'completed': 4,
                'cancelled': -1
            }[status?.toLowerCase()] || 0;
            
            return steps.map((step, index) => `
                <div class="progress-step ${index <= statusIndex ? 'completed' : ''}">
                    <div class="step-icon">${step.icon}</div>
                    <div class="step-label">${step.label}</div>
                    ${index < steps.length - 1 ? '<div class="step-line"></div>' : ''}
                </div>
            `).join('');
        }
        
        // REMOVED: cancelOrder function since we removed the feature
        
        function filterOrders(filter) {
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Now filter orders properly
            filterOrdersByStatus(filter);
        }
        
        async function filterOrdersByStatus(statusFilter) {
            try {
                const orders = await ApiService.getOrders();
                
                if (statusFilter === 'all') {
                    displayOrders(orders);
                    return;
                }
                
                // Filter orders based on status
                const filteredOrders = orders.filter(order => {
                    const orderStatus = order.status?.toLowerCase();
                    const filterStatus = statusFilter?.toLowerCase();
                    
                    return orderStatus === filterStatus;
                });
                
                displayOrders(filteredOrders);
            } catch (error) {
                console.error('Error filtering orders:', error);
            }
        }
        
        function printOrder(orderId) {
            const printContent = document.getElementById('orderDetails').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = `
                <div style="padding: 20px; max-width: 800px; margin: 0 auto;">
                    <h2 style="text-align: center;">USM E-Mart Receipt</h2>
                    ${printContent}
                    <div style="margin-top: 30px; text-align: center; color: #666; font-size: 12px;">
                        Thank you for shopping with USM E-Mart!<br>
                        Student-to-Student Marketplace
                    </div>
                </div>
            `;
            
            window.print();
            document.body.innerHTML = originalContent;
            loadOrders(); // Reload to restore event listeners
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('orderModal');
            if (event.target === modal) {
                closeOrderModal();
            }
        };
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeOrderModal();
            }
        });
    </script>
</body>
</html>
